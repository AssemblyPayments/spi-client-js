!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var i in n)("object"==typeof exports?exports:e)[i]=n[i]}}(window,function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(i,s,function(t){return e[t]}.bind(null,s));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}n.r(t);var a="key_request",r="key_check",u="pair_response",c="drop_keys",l="ping",h="pong",d="purchase_response",f="cancel_transaction",p="cancel_response",g="get_last_transaction",w="last_transaction",C="refund_response",_="signature_required",S="authorisation_code_required",v="cash_response",m="moto_purchase_response",T="settle_response",P="settlement_enquiry_response",y="set_pos_info",F="set_pos_info_response",R="request_use_next_keys",I="error",k="_INVALID_SIGNATURE_",E="get_table_config",b="get_bill_details",x="bill_payment",A="print_response",M="terminal_status",D="battery_level_changed",O={Unknown:"Unknown",Success:"Success",Failed:"Failed"},q=function e(t,n,i){o(this,e),this.PosId=t,this.Secrets=n,this.ServerTimeDelta=i},G=function(){function e(t,n,i,s){o(this,e),this.Id=t,this.EventName=n,this.Data=i,this.DateTimeStamp="",this.PosId="",this.IncommingHmac="",this._needsEncryption=s,this.DecryptedJson=""}return s(e,[{key:"GetSuccessState",value:function(){return this.Data&&void 0!==this.Data.success?this.Data.success?O.Success:O.Failed:O.Unknown}},{key:"GetError",value:function(){return this.Data.error_reason?this.Data.error_reason:""}},{key:"GetErrorDetail",value:function(){return this.Data.error_detail}},{key:"GetServerTimeDelta",value:function(){var e=Date.now(),t=this.DateTimeStamp.split(/[\-\+\. :T]/);return new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5],t[6]).getTime()-e}},{key:"ToJson",value:function(e){var t=Date.now(),n=60*(new Date).getTimezoneOffset()*1e3,i=new Date(t-n+e.ServerTimeDelta);this.DateTimeStamp=i.toISOString().slice(0,-1),this.PosId=e.PosId;var s={message:{id:this.Id,event:this.EventName,data:this.Data,datetime:this.DateTimeStamp}};if(this._needsEncryption||(s.message.pos_id=this.PosId),this.DecryptedJson=JSON.stringify(s),!this._needsEncryption)return this.DecryptedJson;var o=Crypto.AesEncrypt(e.Secrets.EncKey,this.DecryptedJson),a={enc:o,hmac:Crypto.HmacSignature(e.Secrets.HmacKey,o).toUpperCase(),pos_id:e.PosId};return JSON.stringify(a)}}],[{key:"ParseBankDate",value:function(e){return 8!==e.length?null:new Date("".concat(e.substr(4,4),"-").concat(e.substr(2,2),"-").concat(e.substr(0,2)))}},{key:"ParseBankDateTimeStr",value:function(e,t){return new Date("".concat(e.substr(0,2)," ").concat(e.substr(2,3)," ").concat(e.substr(5,2)," ").concat(t))}},{key:"FromJson",value:function(t,n){var i=JSON.parse(t);if(null!=i.message){var s=new e(i.message.id,i.message.event,i.message.data,!1);return s.DecryptedJson=t,s}if(null==n)return new e("UNKNOWN","NOSECRETS",null,!1);if(Crypto.HmacSignature(n.HmacKey,i.enc).toUpperCase()!=i.hmac)return new e("_",k,null,!1);var o=Crypto.AesDecrypt(n.EncKey,i.enc);try{var a=JSON.parse(o),r=new e(a.message.id,a.message.event,a.message.data,!0);return r.DateTimeStamp=a.message.datetime,r.PosId=a.message.pos_id,r.IncomingHmac=i.hmac,r.DecryptedJson=o,r}catch(t){return new e("UNKNOWN","UNPARSEABLE",{msg:o},!1)}}}]),e}();function N(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function L(e,t,n){return t&&N(e.prototype,t),n&&N(e,n),e}function B(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var W="PairedConnected",U="PairedConnecting",K="Unpaired",V="Pairing",j="Transaction",H="Idle",J=function e(t,n){B(this,e),this.Initiated=t,this.Message=n},Y=function(){function e(t,n,i,s,o){B(this,e),this.PosRefId=t,this.Id=t,this.Type=n,this.DisplayMessage=o,this.AmountCents=i,this.RequestSent=!1,this.RequestTime=null,this.LastStateRequestTime=null,this.AttemptingToCancel=null,this.AwaitingSignatureCheck=!1,this.AwaitingPhoneForAuth=null,this.Finished=!1,this.Success=O.Unknown,this.Response=null,this.SignatureRequiredMessage=null,this.PhoneForAuthRequiredMessage=null,this.CancelAttemptTime=null,this.Request=s,this.AwaitingGltResponse=null,this.GLTResponsePosRefId=null}return L(e,[{key:"Sent",value:function(e){this.RequestSent=!0,this.RequestTime=Date.now(),this.LastStateRequestTime=Date.now(),this.DisplayMessage=e}},{key:"Cancelling",value:function(e){this.AttemptingToCancel=!0,this.CancelAttemptTime=Date.now(),this.DisplayMessage=e}},{key:"CancelFailed",value:function(e){this.AttemptingToCancel=!1,this.DisplayMessage=e}},{key:"CallingGlt",value:function(){this.AwaitingGltResponse=!0,this.LastStateRequestTime=Date.now()}},{key:"GotGltResponse",value:function(){this.AwaitingGltResponse=!1}},{key:"Failed",value:function(e,t){this.Success=O.Failed,this.Finished=!0,this.Response=e,this.DisplayMessage=t}},{key:"SignatureRequired",value:function(e,t){this.SignatureRequiredMessage=e,this.AwaitingSignatureCheck=!0,this.DisplayMessage=t}},{key:"SignatureResponded",value:function(e){this.AwaitingSignatureCheck=!1,this.DisplayMessage=e}},{key:"PhoneForAuthRequired",value:function(e,t){this.PhoneForAuthRequiredMessage=e,this.AwaitingPhoneForAuth=!0,this.DisplayMessage=t}},{key:"AuthCodeSent",value:function(e){this.AwaitingPhoneForAuth=!1,this.DisplayMessage=e}},{key:"Completed",value:function(e,t,n){this.Success=e,this.Response=t,this.Finished=!0,this.AttemptingToCancel=!1,this.AwaitingGltResponse=!1,this.AwaitingSignatureCheck=!1,this.AwaitingPhoneForAuth=!1,this.DisplayMessage=n}},{key:"UnknownCompleted",value:function(e){this.Success=O.Unknown,this.Response=null,this.Finished=!0,this.AttemptingToCancel=!1,this.AwaitingGltResponse=!1,this.AwaitingSignatureCheck=!1,this.AwaitingPhoneForAuth=!1,this.DisplayMessage=e}}]),e}(),z=function(){function e(){B(this,e),this.PromptForCustomerCopyOnEftpos=!1,this.SignatureFlowOnEftpos=!1,this.PrintMerchantCopy=!1}return L(e,[{key:"addReceiptConfig",value:function(e){return this.PromptForCustomerCopyOnEftpos&&(e.prompt_for_customer_copy=this.PromptForCustomerCopyOnEftpos),this.SignatureFlowOnEftpos&&(e.print_for_signature_required_transactions=this.SignatureFlowOnEftpos),this.PrintMerchantCopy&&(e.print_merchant_copy=this.PrintMerchantCopy),e}},{key:"ToString",value:function(){return"PromptForCustomerCopyOnEftpos:".concat(this.PromptForCustomerCopyOnEftpos," SignatureFlowOnEftpos:").concat(this.SignatureFlowOnEftpos," PrintMerchantCopy: ").concat(this.PrintMerchantCopy)}}]),e}();function Q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var X=1,Z=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&Q(e.prototype,t),n&&Q(e,n)}(e,null,[{key:"Id",value:function(e){return e+X++}}]),e}();function $(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ee(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var te=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._spi=t,this._log=console,this.Config=Object.assign(new PayAtTableConfig,{PayAtTabledEnabled:!0,OperatorIdEnabled:!0,AllowedOperatorIds:[],EqualSplitEnabled:!0,SplitByAmountEnabled:!0,SummaryReportEnabled:!0,TippingEnabled:!0,LabelOperatorId:"Operator ID",LabelPayButton:"Pay at Table",LabelTableId:"Table Number"})}return function(e,t,n){t&&ee(e.prototype,t),n&&ee(e,n)}(e,[{key:"GetBillStatus",value:function(e,t,n){throw new Exception("Method not implemented. Please overwrite this method in your POS")}},{key:"BillPaymentReceived",value:function(e,t){throw new Exception("Method not implemented. Please overwrite this method in your POS")}},{key:"PushPayAtTableConfig",value:function(){this._spi._send(this.Config.ToMessage(Z.Id("patconf")))}},{key:"_handleGetBillDetailsRequest",value:function(e){var t=e.Data.operator_id,n=e.Data.table_id,i=this.GetBillStatus(null,n,t);i.TableId=n,i.TotalAmount<=0&&(this._log.info("Table has 0 total amount. not sending it to eftpos."),i.Result=BillRetrievalResult.INVALID_TABLE_ID),this._spi._send(i.ToMessage(e.Id))}},{key:"_handleBillPaymentAdvice",value:function(e){var t=new function e(t){$(this,e),this._incomingAdvice=t,this.BillId=this._incomingAdvice.Data.bill_id,this.TableId=this._incomingAdvice.Data.table_id,this.OperatorId=this._incomingAdvice.Data.operator_id;var n=this._incomingAdvice.Data.payment_type;this.PaymentType=n;var i=new Message(t.Id,"payment_details",t.Data.payment_details,!1);this.PurchaseResponse=new PurchaseResponse(i),this.PurchaseAmount=this.PurchaseResponse.GetPurchaseAmount(),this.TipAmount=this.PurchaseResponse.GetTipAmount()}(e),n=this.GetBillStatus(t.BillId,t.TableId,t.OperatorId);n.Result!=BillRetrievalResult.SUCCESS&&(this._log.warn("Could not retrieve Bill Status for Payment Advice. Sending Error to Eftpos."),this._spi._send(n.ToMessage(e.Id)));var i=n.getBillPaymentHistory();if(i.find(function(e){return e.GetTerminalRefId()==t.PurchaseResponse.GetTerminalReferenceId()}))return this._log.warn("Had already received this bill_paymemnt advice from eftpos. Ignoring."),void this._spi._send(n.ToMessage(e.Id));var s=i;s.push(new PaymentHistoryEntry(t.PaymentType.toLowerCase(),t.PurchaseResponse.ToPaymentSummary()));var o=BillStatusResponse.ToBillData(s),a=this.BillPaymentReceived(t,o);a.BillId=t.BillId,a.TableId=t.TableId,a.Result!=BillRetrievalResult.SUCCESS?(this._log.warn("POS Errored when being Advised of Payment. Letting EFTPOS know, and sending existing bill data."),a.BillData=n.BillData):a.BillData=o,this._spi._send(a.ToMessage(e.Id))}},{key:"_handleGetTableConfig",value:function(e){this._spi._send(this.Config.ToMessage(e.Id))}}]),e}();function ne(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ie(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function se(e,t,n){return t&&ie(e.prototype,t),n&&ie(e,n),e}var oe="account_verify",ae="account_verify_response",re="preauth",ue="preauth_response",ce="preauth_topup",le="preauth_topup_response",he="preauth_extend",de="preauth_extend_response",fe="preauth_partial_cancellation",pe="preauth_partial_cancellation_response",ge="preauth_cancellation",we="preauth_cancellation_response",Ce="completion",_e="completion_response",Se=function(){function e(t){ne(this,e),this.PosRefId=t}return se(e,[{key:"ToMessage",value:function(){var e={pos_ref_id:this.PosRefId};return new Message(Z.Id("prav"),oe,e,!0)}}]),e}(),ve=function(){function e(t,n){ne(this,e),this.PosRefId=n,this.PreauthAmount=t}return se(e,[{key:"ToMessage",value:function(){var e={pos_ref_id:this.PosRefId,preauth_amount:this.PreauthAmount};return new Message(Z.Id("prac"),re,e,!0)}}]),e}(),me=function(){function e(t,n,i){ne(this,e),this.PreauthId=t,this.TopupAmount=n,this.PosRefId=i}return se(e,[{key:"ToMessage",value:function(){var e={pos_ref_id:this.PosRefId,preauth_id:this.PreauthId,topup_amount:this.TopupAmount};return new Message(Z.Id("prtu"),ce,e,!0)}}]),e}(),Te=function(){function e(t,n,i){ne(this,e),this.PreauthId=t,this.PartialCancellationAmount=n,this.PosRefId=i}return se(e,[{key:"ToMessage",value:function(){var e={pos_ref_id:this.PosRefId,preauth_id:this.PreauthId,preauth_cancel_amount:this.PartialCancellationAmount};return new Message(Z.Id("prpc"),fe,e,!0)}}]),e}(),Pe=function(){function e(t,n){ne(this,e),this.PreauthId=t,this.PosRefId=n}return se(e,[{key:"ToMessage",value:function(){var e={pos_ref_id:this.PosRefId,preauth_id:this.PreauthId};return new Message(Z.Id("prext"),he,e,!0)}}]),e}(),ye=function(){function e(t,n){ne(this,e),this.PreauthId=t,this.PosRefId=n}return se(e,[{key:"ToMessage",value:function(){var e={pos_ref_id:this.PosRefId,preauth_id:this.PreauthId};return new Message(Z.Id("prac"),ge,e,!0)}}]),e}(),Fe=function(){function e(t,n,i,s){ne(this,e),this.PreauthId=t,this.CompletionAmount=n,this.PosRefId=i,this.SurchargeAmount=s}return se(e,[{key:"ToMessage",value:function(){var e={pos_ref_id:this.PosRefId,preauth_id:this.PreauthId,completion_amount:this.CompletionAmount,surcharge_amount:this.SurchargeAmount};return new Message(Z.Id("prac"),Ce,e,!0)}}]),e}();function Re(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Ie=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._spi=t,this._log=console}return function(e,t,n){t&&Re(e.prototype,t),n&&Re(e,n)}(e,[{key:"InitiateAccountVerifyTx",value:function(e){var t=new Se(e).ToMessage(),n=new Y(e,TransactionType.AccountVerify,0,t,"Waiting for EFTPOS connection to make account verify request");return this._initiatePreauthTx(n,"Asked EFTPOS to verify account")}},{key:"InitiateOpenTx",value:function(e,t){var n=new ve(t,e).ToMessage(),i=new Y(e,TransactionType.Preauth,t,n,"Waiting for EFTPOS connection to make preauth request for ".concat((t/100).toFixed(2))),s="Asked EFTPOS to create preauth for ".concat((t/100).toFixed(2));return this._initiatePreauthTx(i,s)}},{key:"InitiateTopupTx",value:function(e,t,n){var i=new me(t,n,e).ToMessage(),s=new Y(e,TransactionType.Preauth,n,i,"Waiting for EFTPOS connection to make preauth topup request for ".concat((n/100).toFixed(2))),o="Asked EFTPOS to make preauth topup for ".concat((n/100).toFixed(2));return this._initiatePreauthTx(s,o)}},{key:"InitiatePartialCancellationTx",value:function(e,t,n){var i=new Te(t,n,e).ToMessage(),s=new Y(e,TransactionType.Preauth,n,i,"Waiting for EFTPOS connection to make preauth partial cancellation request for ".concat((n/100).toFixed(2))),o="Asked EFTPOS to make preauth partial cancellation for ".concat((n/100).toFixed(2));return this._initiatePreauthTx(s,o)}},{key:"InitiateExtendTx",value:function(e,t){var n=new Pe(t,e).ToMessage(),i=new Y(e,TransactionType.Preauth,0,n,"Waiting for EFTPOS connection to make preauth Extend request");return this._initiatePreauthTx(i,"Asked EFTPOS to make preauth Extend request")}},{key:"InitiateCompletionTx",value:function(e,t,n,i){var s=new Fe(t,n,e,i).ToMessage(),o=new Y(e,TransactionType.Preauth,n,s,"Waiting for EFTPOS connection to make preauth completion request for ".concat((n/100).toFixed(2))),a="Asked EFTPOS to make preauth completion for ".concat((n/100).toFixed(2));return this._initiatePreauthTx(o,a)}},{key:"InitiateCancelTx",value:function(e,t){var n=new ye(t,e).ToMessage(),i=new Y(e,TransactionType.Preauth,0,n,"Waiting for EFTPOS connection to make preauth cancellation request");return this._initiatePreauthTx(i,"Asked EFTPOS to make preauth cancellation request")}},{key:"_initiatePreauthTx",value:function(e,t){return this._spi.CurrentStatus==SpiStatus.Unpaired?new J(!1,"Not Paired"):this._spi.CurrentFlow!=SpiFlow.Idle?new J(!1,"Not Idle"):(this._spi.CurrentFlow=SpiFlow.Transaction,this._spi.CurrentTxFlowState=e,this._spi._send(e.Request)&&this._spi.CurrentTxFlowState.Sent(t),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this._spi.CurrentTxFlowState})),new J(!0,"Preauth Initiated"))}},{key:"_handlePreauthMessage",value:function(e){switch(e.EventName){case ae:this._handleAccountVerifyResponse(e);break;case ue:case le:case pe:case de:case _e:case we:this._handlePreauthResponse(e);break;default:this._log.info("I don't Understand Preauth Event: ".concat(e.EventName,", ").concat(e.Data,". Perhaps I have not implemented it yet."))}}},{key:"_handleAccountVerifyResponse",value:function(e){var t=e.Data.pos_ref_id,n=this._spi.CurrentTxFlowState;this._spi.CurrentFlow!=SpiFlow.Transaction||n.Finished||!n.PosRefId===t?this._log.info("Received Account Verify response but I was not waiting for one. Incoming Pos Ref ID: ".concat(t)):(n.Completed(e.GetSuccessState(),e,"Account Verify Transaction Ended."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this._spi.CurrentTxFlowState})))}},{key:"_handlePreauthResponse",value:function(e){var t=e.Data.pos_ref_id,n=this._spi.CurrentTxFlowState;this._spi.CurrentFlow!=SpiFlow.Transaction||n.Finished||!n.PosRefId===t?this._log.info("Received Preauth response but I was not waiting for one. Incoming Pos Ref ID: ".concat(t)):(n.Completed(e.GetSuccessState(),e,"Preauth Transaction Ended."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this._spi.CurrentTxFlowState})))}}],[{key:"IsPreauthEvent",value:function(e){return 0===e.lastIndexOf("preauth",0)||e==_e||e==Ce||e==oe||e==ae}}]),e}();function ke(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ee(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function be(e,t,n){return t&&Ee(e.prototype,t),n&&Ee(e,n),e}var xe=function(){function e(){ke(this,e)}return be(e,[{key:"ToMessage",value:function(){return new Message(Z.Id("drpkys"),c,null,!0)}}]),e}();function Ae(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Me(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function De(e,t,n){return t&&Me(e.prototype,t),n&&Me(e,n),e}var Oe=function(){function e(t,n,i,s,o){Ae(this,e),this._version=t,this._vendorId=n,this._libraryLanguage=i,this._libraryVersion=s,this._otherInfo=o}return De(e,[{key:"toMessage",value:function(){var e={pos_version:this._version,pos_vendor_id:this._vendorId,library_language:this._libraryLanguage,library_version:this._libraryVersion,other_info:this._otherInfo};return new Message(RequestIdHelper.Id("prav"),y,e,!0)}}]),e}();function qe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ge(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Ne(e,t,n){return t&&Ge(e.prototype,t),n&&Ge(e,n),e}var Le=function(){function e(){qe(this,e)}return Ne(e,[{key:"ToMessage",value:function(){return new Message(Z.Id("ctx"),f,null,!0)}}]),e}(),Be=function(){function e(t){qe(this,e),this._m=t,this.PosRefId=this._m.Data.pos_ref_id,this.Success=this._m.GetSuccessState()==O.Success}return Ne(e,[{key:"GetErrorReason",value:function(){return this._m.Data.error_reason}},{key:"GetErrorDetail",value:function(){return this._m.Data.error_detail}},{key:"GetResponseValueWithAttribute",value:function(e){return this._m.Data[e]}}]),e}(),We=function(){function e(){qe(this,e)}return Ne(e,[{key:"ToMessage",value:function(){return new Message(Z.Id("glt"),g,null,!0)}}]),e}(),Ue=function(){function e(t){qe(this,e),this.RequestId=t.Id,this.PosRefId=t.Data.pos_ref_id,this._receiptToSign=t.Data.merchant_receipt}return Ne(e,[{key:"SignatureRequired",value:function(e,t,n){this.RequestId=t,this.PosRefId=e,this._receiptToSign=n}},{key:"GetMerchantReceipt",value:function(){return this._receiptToSign}}]),e}();function Ke(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Ve(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var je=function(){function e(){Ve(this,e)}return function(e,t,n){t&&Ke(e.prototype,t),n&&Ke(e,n)}(e,[{key:"RetrieveService",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"spi-sample-pos1",n="https://device-address-api-dev.nonprod-wbc.msp.assemblypayments.com/v1/".concat(e,"/ip");return fetch(n,{method:"GET",headers:{"ASM-MSP-DEVICE-ADDRESS-API-KEY":t}}).then(function(e){return e.json()}).catch(function(e){console.error("Status code ".concat(e.StatusCode," received from ").concat(n," - Exception ").concat(e.ErrorException))})}}]),e}();function He(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Je(e,t,n){return t&&He(e.prototype,t),n&&He(e,n),e}var Ye=function(){function e(t,n,i,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._posId=t,this._secrets=i,this._eftposAddress="ws://"+n,this._log=console,this.Config=new z,s&&(this._serialNumber=s.SerialNumber,this._deviceApiKey=s.ApiKey),this.CurrentDeviceStatus=null,this.AutoIpResolutionEnable=!1,this._spiMessageStamp=new q(this._posId,this._secrets,0),this._posVendorId=null,this._posVersion=null,this._hasSetInfo=null,this._mostRecentPingSent=null,this._mostRecentPongReceived=null,this._missedPongsCount=0,this._retrySinceLastDeviceIpAddressResolution=0,this._mostRecentLoginResponse=null,this._pongTimeout=5e3,this._pingFrequency=18e3,this._readyToTransact=null,this._periodicPingThread=null,this._txMonitorCheckFrequency=1e3,this._checkOnTxFrequency=2e4,this._maxWaitForCancelTx=1e4,this._missedPongsToDisconnect=2,this._retryBeforeResolvingDeviceIpAddress=5,this.CurrentFlow=null,this.CurrentPairingFlowState=null,this.CurrentTxFlowState=null}return Je(e,[{key:"CurrentStatus",get:function(){return this._currentStatus},set:function(e){this._currentStatus!==e&&(this._currentStatus=e,document.dispatchEvent(new CustomEvent("StatusChanged",{detail:e})))}}]),Je(e,[{key:"EnablePayAtTable",value:function(){return this._spiPat=new te(this),this._spiPat}},{key:"EnablePreauth",value:function(){return this._spiPreauth=new Ie(this),this._spiPreauth}},{key:"Start",value:function(){if(!this._posVendorId||!this._posVersion)throw this._log.Warn("Missing POS vendor ID and version. posVendorId and posVersion are required before starting"),new Exception("Missing POS vendor ID and version. posVendorId and posVersion are required before starting");this._resetConn(),this._startTransactionMonitoringThread(),this.CurrentFlow=H,null!=this._secrets?(this._log.info("Starting in Paired State"),this._currentStatus=U,this._conn.Connect()):(this._log.info("Starting in Unpaired State"),this._currentStatus=K)}},{key:"SetPosId",value:function(e){return this.CurrentStatus==K&&(this._posId=e,this._spiMessageStamp.PosId=e,!0)}},{key:"SetEftposAddress",value:function(e){return this.CurrentStatus!=W&&(this._eftposAddress="ws://"+e,this._conn.Address=this._eftposAddress,!0)}},{key:"GetDeviceIpAddress",value:function(e){this.CurrentStatus!=W&&(this._serialNumber=e.SerialNumber,this._deviceApiKey=e.ApiKey,this.ResolveDeviceIpAddress())}},{key:"SetPosInfo",value:function(e,t){this._posVendorId=e,this._posVersion=t}},{key:"AckFlowEndedAndBackToIdle",value:function(){return this.CurrentFlow==H||(this.CurrentFlow==V&&this.CurrentPairingFlowState.Finished?(this.CurrentFlow=H,!0):!(this.CurrentFlow!=j||!this.CurrentTxFlowState.Finished)&&(this.CurrentFlow=H,!0))}},{key:"Pair",value:function(){return this.CurrentStatus!=K?(this._log.warn("Tried to Pair but we're already so."),!1):this._posId&&this._eftposAddress?(this.CurrentFlow=V,this.CurrentPairingFlowState=new function e(t){B(this,e),this.Message=null,this.AwaitingCheckFromEftpos=null,this.AwaitingCheckFromPos=null,this.ConfirmationCode=null,this.Finished=null,this.Successful=null,t&&Object.assign(this,t)}({Successful:!1,Finished:!1,Message:"Connecting...",AwaitingCheckFromEftpos:!1,AwaitingCheckFromPos:!1,ConfirmationCode:""}),document.dispatchEvent(new CustomEvent("PairingFlowStateChanged",{detail:this.CurrentPairingFlowState})),this._conn.Connect(),!0):(this._log.warn("Tried to Pair but missing posId or eftposAddress"),!1)}},{key:"PairingConfirmCode",value:function(){this.CurrentPairingFlowState.AwaitingCheckFromPos&&(this.CurrentPairingFlowState.AwaitingCheckFromPos=!1,this.CurrentPairingFlowState.AwaitingCheckFromEftpos?(this._log.info("Pair Code Confirmed from POS side, but am still waiting for confirmation from Eftpos."),this.CurrentPairingFlowState.Message="Click YES on EFTPOS if code is: "+this.CurrentPairingFlowState.ConfirmationCode,document.dispatchEvent(new CustomEvent("PairingFlowStateChanged",{detail:this.CurrentPairingFlowState}))):(this._log.info("Pair Code Confirmed from POS side, and was already confirmed from Eftpos side. Pairing finalised."),this._onPairingSuccess(),this._onReadyToTransact()))}},{key:"PairingCancel",value:function(){this.CurrentFlow!=V||this.CurrentPairingFlowState.Finished||(this.CurrentPairingFlowState.AwaitingCheckFromPos&&!this.CurrentPairingFlowState.AwaitingCheckFromEftpos&&this._send((new xe).ToMessage()),this._onPairingFailed())}},{key:"Unpair",value:function(){return this.CurrentStatus!=K&&(this.CurrentFlow==H&&(this._send((new xe).ToMessage()),this._doUnpair(),!0))}},{key:"InitiatePurchaseTx",value:function(e,t){if(this.CurrentStatus==K)return new J(!1,"Not Paired");if(this.CurrentFlow!=H)return new J(!1,"Not Idle");var n=PurchaseHelper.CreatePurchaseRequest(t,e);n.Config=this.Config;var i=n.ToMessage();return this.CurrentFlow=j,this.CurrentTxFlowState=new Y(e,TransactionType.Purchase,t,i,"Waiting for EFTPOS connection to make payment request for ".concat(t/100)),this._send(i)&&this.CurrentTxFlowState.Sent("Asked EFTPOS to accept payment for ".concat(t/100)),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new J(!0,"Purchase Initiated")}},{key:"InitiatePurchaseTxV2",value:function(e,t,n,i,s){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(this.CurrentStatus==K)return new J(!1,"Not Paired");if(n>0&&(i>0||s))return new J(!1,"Cannot Accept Tips and Cashout at the same time.");if(this.CurrentFlow!=H)return new J(!1,"Not Idle");this.CurrentFlow=j;var r=PurchaseHelper.CreatePurchaseRequestV2(e,t,n,i,s,a);r.Config=this.Config,r.Options=o;var u=r.ToMessage();return this.CurrentTxFlowState=new Y(e,TransactionType.Purchase,t,u,"Waiting for EFTPOS connection to make payment request. ".concat(r.AmountSummary())),this._send(u)&&this.CurrentTxFlowState.Sent("Asked EFTPOS to accept payment for ".concat(r.AmountSummary())),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new J(!0,"Purchase Initiated")}},{key:"InitiateRefundTx",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.CurrentStatus==K)return new J(!1,"Not Paired");if(this.CurrentFlow!=H)return new J(!1,"Not Idle");var i=PurchaseHelper.CreateRefundRequest(t,e,n);i.Config=this.Config;var s=i.ToMessage();return this.CurrentFlow=j,this.CurrentTxFlowState=new Y(e,TransactionType.Refund,t,s,"Waiting for EFTPOS connection to make refund request for ".concat((t/100).toFixed(2))),this._send(s)&&this.CurrentTxFlowState.Sent("Asked EFTPOS to refund ".concat((t/100).toFixed(2))),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new J(!0,"Refund Initiated")}},{key:"AcceptSignature",value:function(e){if(this.CurrentFlow!=j||this.CurrentTxFlowState.Finished||!this.CurrentTxFlowState.AwaitingSignatureCheck)return this._log.info("Asked to accept signature but I was not waiting for one."),new MidTxResult(!1,"Asked to accept signature but I was not waiting for one.");this.CurrentTxFlowState.SignatureResponded(e?"Accepting Signature...":"Declining Signature...");this.CurrentTxFlowState.SignatureRequiredMessage;return this._send(e?new SignatureAccept(this.CurrentTxFlowState.PosRefId).ToMessage():new SignatureDecline(this.CurrentTxFlowState.PosRefId).ToMessage()),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new MidTxResult(!0,"")}},{key:"SubmitAuthCode",value:function(e){return 6!=e.length?new SubmitAuthCodeResult(!1,"Not a 6-digit code."):this.CurrentFlow!=j||this.CurrentTxFlowState.Finished||!this.CurrentTxFlowState.AwaitingPhoneForAuth?(this._log.info("Asked to send auth code but I was not waiting for one."),new SubmitAuthCodeResult(!1,"Was not waiting for one.")):(this.CurrentTxFlowState.AuthCodeSent("Submitting Auth Code ".concat(e)),this._send(new AuthCodeAdvice(this.CurrentTxFlowState.PosRefId,e).ToMessage()),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new SubmitAuthCodeResult(!0,"Valid Code."))}},{key:"CancelTransaction",value:function(){if(this.CurrentFlow!=j||this.CurrentTxFlowState.Finished)return this._log.info("Asked to cancel transaction but I was not in the middle of one."),new MidTxResult(!1,"Asked to cancel transaction but I was not in the middle of one.");if(this.CurrentTxFlowState.RequestSent){var e=new Le;this.CurrentTxFlowState.Cancelling("Attempting to Cancel Transaction..."),this._send(e.ToMessage())}else this.CurrentTxFlowState.Failed(null,"Transaction Cancelled. Request Had not even been sent yet.");return document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new MidTxResult(!0,"")}},{key:"InitiateCashoutOnlyTx",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.CurrentStatus==K)return new J(!1,"Not Paired");if(this.CurrentFlow!=H)return new J(!1,"Not Idle");var i=new CashoutOnlyRequest(t,e,n);i.Config=this.Config;var s=i.ToMessage();return this.CurrentFlow=j,this.CurrentTxFlowState=new Y(e,TransactionType.CashoutOnly,t,s,"Waiting for EFTPOS connection to send cashout request for ".concat((t/100).toFixed(2))),this._send(s)&&this.CurrentTxFlowState.Sent("Asked EFTPOS to do cashout for ".concat((t/100).toFixed(2))),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new J(!0,"Cashout Initiated")}},{key:"InitiateMotoPurchaseTx",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.CurrentStatus==K)return new J(!1,"Not Paired");if(this.CurrentFlow!=H)return new J(!1,"Not Idle");var i=new MotoPurchaseRequest(t,e,n);i.Config=this.Config;var s=i.ToMessage();return this.CurrentFlow=j,this.CurrentTxFlowState=new Y(e,TransactionType.MOTO,t,s,"Waiting for EFTPOS connection to send MOTO request for ".concat((t/100).toFixed(2))),this._send(s)&&this.CurrentTxFlowState.Sent("Asked EFTPOS do MOTO for ".concat((t/100).toFixed(2))),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new J(!0,"MOTO Initiated")}},{key:"InitiateSettleTx",value:function(e){if(this.CurrentStatus==K)return new J(!1,"Not Paired");if(this.CurrentFlow!=H)return new J(!1,"Not Idle");var t=new SettleRequest(Z.Id("settle")).ToMessage();return this.CurrentFlow=j,this.CurrentTxFlowState=new Y(e,TransactionType.Settle,0,t,"Waiting for EFTPOS connection to make a settle request"),this._send(t)&&this.CurrentTxFlowState.Sent("Asked EFTPOS to settle."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new J(!0,"Settle Initiated")}},{key:"InitiateSettlementEnquiry",value:function(e){if(this.CurrentStatus==K)return new J(!1,"Not Paired");if(this.CurrentFlow!=H)return new J(!1,"Not Idle");var t=new SettlementEnquiryRequest(Z.Id("stlenq")).ToMessage();return this.CurrentFlow=j,this.CurrentTxFlowState=new Y(e,TransactionType.SettlementEnquiry,0,t,"Waiting for EFTPOS connection to make a settlement enquiry"),this._send(t)&&this.CurrentTxFlowState.Sent("Asked EFTPOS to make a settlement enquiry."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new J(!0,"Settle Initiated")}},{key:"InitiateGetLastTx",value:function(){if(this.CurrentStatus==K)return new J(!1,"Not Paired");if(this.CurrentFlow!=H)return new J(!1,"Not Idle");var e=(new We).ToMessage();this.CurrentFlow=j;var t=e.Id;return this.CurrentTxFlowState=new Y(t,TransactionType.GetLastTransaction,0,e,"Waiting for EFTPOS connection to make a Get-Last-Transaction request."),this._send(e)&&this.CurrentTxFlowState.Sent("Asked EFTPOS for last transaction."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new J(!0,"GLT Initiated")}},{key:"InitiateRecovery",value:function(e,t){if(this.CurrentStatus==K)return new J(!1,"Not Paired");if(this.CurrentFlow!=H)return new J(!1,"Not Idle");this.CurrentFlow=j;var n=(new We).ToMessage();return this.CurrentTxFlowState=new Y(e,t,0,n,"Waiting for EFTPOS connection to attempt recovery."),this._send(n)&&this.CurrentTxFlowState.Sent("Asked EFTPOS to recover state."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),new J(!0,"Recovery Initiated")}},{key:"GltMatch",value:function(e,t){if(!(arguments.length<=2)&&arguments.length-2){if(2==(arguments.length<=2?0:arguments.length-2))return this._log.info("Obsolete method call detected: Use GltMatch(gltResponse, posRefId)"),this.GltMatch(e,arguments.length<=4?void 0:arguments[4]);throw new Error("Obsolete method call with unknown args: Use GltMatch(GetLastTransactionResponse gltResponse, string posRefId)")}return this._log.info("GLT CHECK: PosRefId: ".concat(t,"->").concat(e.GetPosRefId())),!t==e.GetPosRefId()?O.Unknown:e.GetSuccessState()}},{key:"PrintReceipt",value:function(e,t){this._send(new PrintingRequest(e,t).toMessage())}},{key:"GetTerminalStatus",value:function(){this._send((new TerminalStatusRequest).ToMessage())}},{key:"_handleKeyRequest",value:function(e){this.CurrentPairingFlowState.Message="Negotiating Pairing...",document.dispatchEvent(new CustomEvent("PairingFlowStateChanged",{detail:this.CurrentPairingFlowState}));var t=(new PairingHelper).GenerateSecretsAndKeyResponse(new KeyRequest(e));this._secrets=t.Secrets,this._spiMessageStamp.Secrets=this._secrets,this._send(t.KeyResponse.ToMessage())}},{key:"_handleKeyCheck",value:function(e){var t=new KeyCheck(e);this.CurrentPairingFlowState.ConfirmationCode=t.ConfirmationCode,this.CurrentPairingFlowState.AwaitingCheckFromEftpos=!0,this.CurrentPairingFlowState.AwaitingCheckFromPos=!0,this.CurrentPairingFlowState.Message="Confirm that the following Code is showing on the Terminal",document.dispatchEvent(new CustomEvent("PairingFlowStateChanged",{detail:this.CurrentPairingFlowState}))}},{key:"_handlePairResponse",value:function(e){var t=new PairResponse(e);this.CurrentPairingFlowState.AwaitingCheckFromEftpos=!1,t.Success?(this.CurrentPairingFlowState.AwaitingCheckFromPos?(this._log.info("Got Pair Confirm from Eftpos, but still waiting for use to confirm from POS."),this.CurrentPairingFlowState.Message="Confirm that the following Code is what the EFTPOS showed",document.dispatchEvent(new CustomEvent("PairingFlowStateChanged",{detail:this.CurrentPairingFlowState}))):(this._log.info("Got Pair Confirm from Eftpos, and already had confirm from POS. Now just waiting for first pong."),this._onPairingSuccess()),this._startPeriodicPing()):this._onPairingFailed()}},{key:"_handleDropKeysAdvice",value:function(e){this._log.Info("Eftpos was Unpaired. I shall unpair from my end as well."),this._doUnpair()}},{key:"_onPairingSuccess",value:function(){this.CurrentPairingFlowState.Successful=!0,this.CurrentPairingFlowState.Finished=!0,this.CurrentPairingFlowState.Message="Pairing Successful!",this.CurrentStatus=W,document.dispatchEvent(new CustomEvent("SecretsChanged",{detail:this._secrets})),document.dispatchEvent(new CustomEvent("PairingFlowStateChanged",{detail:this.CurrentPairingFlowState}))}},{key:"_onPairingFailed",value:function(){this._secrets=null,this._spiMessageStamp.Secrets=null,this._conn.Disconnect(),this.CurrentStatus=K,this.CurrentPairingFlowState.Message="Pairing Failed",this.CurrentPairingFlowState.Finished=!0,this.CurrentPairingFlowState.Successful=!1,this.CurrentPairingFlowState.AwaitingCheckFromPos=!1,document.dispatchEvent(new CustomEvent("PairingFlowStateChanged",{detail:this.CurrentPairingFlowState}))}},{key:"_doUnpair",value:function(){this.CurrentStatus=K,this._conn.Disconnect(),this._secrets=null,this._spiMessageStamp.Secrets=null,document.dispatchEvent(new CustomEvent("SecretsChanged",{detail:this._secrets}))}},{key:"_handleKeyRollingRequest",value:function(e){var t=KeyRollingHelper.PerformKeyRolling(e,this._secrets);this._secrets=t.NewSecrets,this._spiMessageStamp.Secrets=this._secrets,this._send(t.KeyRollingConfirmation),document.dispatchEvent(new CustomEvent("SecretsChanged",{detail:this._secrets}))}},{key:"_handleSignatureRequired",value:function(e){var t=e.Data.pos_ref_id;this.CurrentFlow!=j||this.CurrentTxFlowState.Finished||!this.CurrentTxFlowState.PosRefId==t?this._log.info("Received Signature Required but I was not waiting for one. Incoming Pos Ref ID: ".concat(t)):(this.CurrentTxFlowState.SignatureRequired(new Ue(e),"Ask Customer to Sign the Receipt"),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})))}},{key:"_handleAuthCodeRequired",value:function(e){var t=e.Data.pos_ref_id;if(this.CurrentFlow!=j||this.CurrentTxFlowState.Finished||!this.CurrentTxFlowState.PosRefId==t)_log.Info("Received Auth Code Required but I was not waiting for one. Incoming Pos Ref ID: ".concat(t));else{var n=new PhoneForAuthRequired(e),i="Auth Code Required. Call ".concat(n.GetPhoneNumber()," and quote merchant id ").concat(n.GetMerchantId());this.CurrentTxFlowState.PhoneForAuthRequired(n,i),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState}))}}},{key:"_handlePurchaseResponse",value:function(e){var t=e.Data.pos_ref_id;this.CurrentFlow!=j||this.CurrentTxFlowState.Finished||!this.CurrentTxFlowState.PosRefId==t?this._log.info("Received Purchase response but I was not waiting for one. Incoming Pos Ref ID: ".concat(t,'"')):(this.CurrentTxFlowState.Completed(e.GetSuccessState(),e,"Purchase Transaction Ended."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})))}},{key:"_handleCashoutOnlyResponse",value:function(e){var t=e.Data.pos_ref_id;this.CurrentFlow!=j||this.CurrentTxFlowState.Finished||!this.CurrentTxFlowState.PosRefId==t?this._log.info("Received Cashout Response but I was not waiting for one. Incoming Pos Ref ID: ".concat(t)):(this.CurrentTxFlowState.Completed(e.GetSuccessState(),e,"Cashout Transaction Ended."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})))}},{key:"_handleMotoPurchaseResponse",value:function(e){var t=e.Data.pos_ref_id;this.CurrentFlow!=j||this.CurrentTxFlowState.Finished||!this.CurrentTxFlowState.PosRefId==t?this._log.info("Received Moto Response but I was not waiting for one. Incoming Pos Ref ID: ".concat(t)):(this.CurrentTxFlowState.Completed(e.GetSuccessState(),e,"Moto Transaction Ended."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})))}},{key:"_handleRefundResponse",value:function(e){var t=e.Data.pos_ref_id;this.CurrentFlow!=j||this.CurrentTxFlowState.Finished|!this.CurrentTxFlowState.PosRefId==t?this._log.info("Received Refund response but I was not waiting for this one. Incoming Pos Ref ID: ".concat(t)):(this.CurrentTxFlowState.Completed(e.GetSuccessState(),e,"Refund Transaction Ended."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})))}},{key:"HandleSettleResponse",value:function(e){this.CurrentFlow!=j||this.CurrentTxFlowState.Finished?this._log.info("Received Settle response but I was not waiting for one. ".concat(e.DecryptedJson)):(this.CurrentTxFlowState.Completed(e.GetSuccessState(),e,"Settle Transaction Ended."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})))}},{key:"_handleSettlementEnquiryResponse",value:function(e){this.CurrentFlow!=j||this.CurrentTxFlowState.Finished?this._log.info("Received Settlement Enquiry response but I was not waiting for one. ".concat(e.DecryptedJson)):(this.CurrentTxFlowState.Completed(e.GetSuccessState(),e,"Settlement Enquiry Ended."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})))}},{key:"_handleErrorEvent",value:function(e){this.CurrentFlow==j&&!this.CurrentTxFlowState.Finished&&this.CurrentTxFlowState.AttemptingToCancel&&"NO_TRANSACTION"==e.GetError()?(this._log.info("Was trying to cancel a transaction but there is nothing to cancel. Calling GLT to see what's up"),this._callGetLastTransaction()):this._log.info("Received Error Event But Don't know what to do with it. ".concat(e.DecryptedJson))}},{key:"_handleGetLastTransactionResponse",value:function(e){var t=this.CurrentTxFlowState;if(this.CurrentFlow==j&&!t.Finished){this._log.info("Got Last Transaction.."),t.GotGltResponse();var n=new GetLastTransactionResponse(e);if(t.GLTResponsePosRefId=n.GetPosRefId(),n.WasRetrievedSuccessfully())if(t.Type==TransactionType.GetLastTransaction)this._log.info("Retrieved Last Transaction as asked directly by the user."),n.CopyMerchantReceiptToCustomerReceipt(),t.Completed(e.GetSuccessState(),e,"Last Transaction Retrieved");else{var i=this.GltMatch(n,t.PosRefId);i==O.Unknown?(this._log.info("Did not match transaction."),t.UnknownCompleted("Failed to recover Transaction Status. Check EFTPOS. ")):(n.CopyMerchantReceiptToCustomerReceipt(),t.Completed(i,e,"Transaction Ended."))}else if(n.IsStillInProgress(t.PosRefId))if(n.IsWaitingForSignatureResponse()&&!t.AwaitingSignatureCheck)this._log.info("Eftpos is waiting for us to send it signature accept/decline, but we were not aware of this. The user can only really decline at this stage as there is no receipt to print for signing."),this.CurrentTxFlowState.SignatureRequired(new Ue(t.PosRefId,e.Id,"MISSING RECEIPT\n DECLINE AND TRY AGAIN."),"Recovered in Signature Required but we don't have receipt. You may Decline then Retry.");else{if(!n.IsWaitingForAuthCode()||t.AwaitingPhoneForAuth)return void this._log.info("Operation still in progress... stay waiting.");this._log.info("Eftpos is waiting for us to send it auth code, but we were not aware of this. We can only cancel the transaction at this stage as we don't have enough information to recover from this."),this.CurrentTxFlowState.PhoneForAuthRequired(new PhoneForAuthRequired(t.PosRefId,e.Id,"UNKNOWN","UNKNOWN"),"Recovered mid Phone-For-Auth but don't have details. You may Cancel then Retry.")}else{if(n.WasTimeOutOfSyncError())return void this._log.info("Time-Out-Of-Sync error in Get Last Transaction response. Let's ignore it and we'll try again.");this._log.info("Unexpected Response in Get Last Transaction during - Received posRefId:".concat(n.GetPosRefId()," Error:").concat(e.GetError())),t.UnknownCompleted("Unexpected Error when recovering Transaction Status. Check EFTPOS. ")}document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:t}))}}},{key:"_handleCancelTransactionResponse",value:function(e){var t=e.Data.pos_ref_id;if(this.CurrentFlow!=j||this.CurrentTxFlowState.Finished||!this.CurrentTxFlowState.PosRefId==t)this._log.Info("Received Cancel Required but I was not waiting for one. Incoming Pos Ref ID: ".concat(t));else{var n=this.CurrentTxFlowState,i=new Be(e);i.Success||(this._log.Warn("Failed to cancel transaction: reason="+i.GetErrorReason()+", detail="+i.GetErrorDetail()),n.CancelFailed("Failed to cancel transaction: "+i.GetErrorDetail()+". Check EFTPOS."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:n})))}}},{key:"_handleSetPosInfoResponse",value:function(e){var t=new SetPosInfoResponse(e);t.isSuccess()?(this._hasSetInfo=!0,this._log.Info("Setting POS info successful")):this._log.Warn("Setting POS info failed: reason="+t.getErrorReason()+", detail="+t.getErrorDetail())}},{key:"_startTransactionMonitoringThread",value:function(){var e=this,t=!1,n=this.CurrentTxFlowState;if(this.CurrentFlow==j&&!n.Finished){var i=n;i.AttemptingToCancel&&Date.now()>i.CancelAttemptTime+this._maxWaitForCancelTx?(this._log.info("Been too long waiting for transaction to cancel."),n.UnknownCompleted("Waited long enough for Cancel Transaction result. Check EFTPOS. "),t=!0):i.RequestSent&&Date.now()>i.LastStateRequestTime+this._checkOnTxFrequency&&(this._log.info("Checking on our transaction. Last we asked was at ".concat(i.LastStateRequestTime,"...")),n.CallingGlt(),this._callGetLastTransaction())}t&&document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})),setTimeout(function(){return e._startTransactionMonitoringThread()},this._txMonitorCheckFrequency)}},{key:"PrintingResponse",value:function(e){throw new Exception("Method not implemented. Please overwrite this method in your POS")}},{key:"TerminalStatusResponse",value:function(e){throw new Exception("Method not implemented. Please overwrite this method in your POS")}},{key:"BatteryLevelChanged",value:function(e){throw new Exception("Method not implemented. Please overwrite this method in your POS")}},{key:"_handlePrintingResponse",value:function(e){this.PrintingResponse(e)}},{key:"_handleTerminalStatusResponse",value:function(e){this.TerminalStatusResponse(e)}},{key:"_handleBatteryLevelChanged",value:function(e){this.BatteryLevelChanged(e)}},{key:"_resetConn",value:function(){var e=this;this._conn=new Connection,this._conn.Address=this._eftposAddress,document.addEventListener("ConnectionStatusChanged",function(t){return e._onSpiConnectionStatusChanged(t.detail)}),document.addEventListener("MessageReceived",function(t){return e._onSpiMessageReceived(t.detail)}),document.addEventListener("ErrorReceived",function(t){return e._onWsErrorReceived(t.detail)})}},{key:"_onSpiConnectionStatusChanged",value:function(e){var t=this;switch(e.ConnectionState){case ConnectionState.Connecting:this._log.info("I'm Connecting to the Eftpos at ".concat(this._eftposAddress,"..."));break;case ConnectionState.Connected:if(this._retrySinceLastDeviceIpAddressResolution=0,this.CurrentFlow==V&&this.CurrentStatus==K){this.CurrentPairingFlowState.Message="Requesting to Pair...",document.dispatchEvent(new CustomEvent("PairingFlowStateChanged",{detail:this.CurrentPairingFlowState}));var n=PairingHelper.NewPairRequest();this._send(n.ToMessage())}else this._log.info("I'm Connected to ".concat(this._eftposAddress,"...")),this._spiMessageStamp.Secrets=this._secrets,this._startPeriodicPing();break;case ConnectionState.Disconnected:if(this._log.info("I'm disconnected from ".concat(this._eftposAddress,"...")),this._mostRecentPingSent=null,this._mostRecentPongReceived=null,this._missedPongsCount=0,this._stopPeriodicPing(),this.CurrentStatus!=K){if(this.CurrentStatus=U,this.CurrentFlow!=j||this.CurrentTxFlowState.Finished||this._log.info("Lost connection in the middle of a transaction..."),null==this._conn)return;this._retrySinceLastDeviceIpAddressResolution>=this._retryBeforeResolvingDeviceIpAddress?(this.ResolveDeviceIpAddress(),this._retrySinceLastDeviceIpAddressResolution=0):(this._retrySinceLastDeviceIpAddressResolution+=1,this._log.info("Will try to reconnect in 5s..."),setTimeout(function(){t.CurrentStatus!=K&&t._conn.Connect()},5e3))}else this.CurrentFlow==V&&(this._log.info("Lost Connection during pairing."),this.CurrentPairingFlowState.Message="Could not Connect to Pair. Check Network and Try Again...",this._onPairingFailed(),document.dispatchEvent(new CustomEvent("PairingFlowStateChanged",{detail:this.CurrentPairingFlowState})));break;default:throw new Exception("Unknown state: "+e)}}},{key:"_startPeriodicPing",value:function(){var e=this;this._stopPeriodicPing(),this._periodicPingThread=setInterval(function(){return e._periodicPing()},this._pingFrequency),this._periodicPing()}},{key:"_periodicPing",value:function(){var e=this;this._conn.Connected&&null!=this._secrets?(this._doPing(),setTimeout(function(){if(null!=e._mostRecentPingSent&&(null==e._mostRecentPongReceived||e._mostRecentPongReceived.Id!=e._mostRecentPingSent.Id)){if(e._missedPongsCount+=1,e._log.info("Eftpos didn't reply to my Ping. Missed Count: ".concat(e._missedPongsCount,"/").concat(e._missedPongsToDisconnect,".")),e._missedPongsCount<e._missedPongsToDisconnect)return e._log.info("Trying another ping..."),void e._startPeriodicPing();e._log.info("Disconnecting..."),e._conn.Disconnect(),e._stopPeriodicPing()}e._missedPongsCount=0},this._pongTimeout)):(this._stopPeriodicPing(),this._log.info("Cancelling periodic ping as were disconnected or not paired"))}},{key:"_onReadyToTransact",value:function(){this._log.info("On Ready To Transact!"),this.CurrentStatus=W,this.CurrentFlow!=j||this.CurrentTxFlowState.Finished?(this._hasSetInfo||this._callSetPosInfo(),this._spiPat&&this._spiPat.PushPayAtTableConfig()):this.CurrentTxFlowState.RequestSent?(this.CurrentTxFlowState.CallingGlt(),this._callGetLastTransaction()):(this._send(this.CurrentTxFlowState.Request),this.CurrentTxFlowState.Sent("Sending Request Now..."),document.dispatchEvent(new CustomEvent("TxFlowStateChanged",{detail:this.CurrentTxFlowState})))}},{key:"_callSetPosInfo",value:function(){var e=new Oe(this._posVersion,this._posVendorId,"js",this.GetVersion(),DeviceInfo.GetAppDeviceInfo());this._send(e.toMessage())}},{key:"_stopPeriodicPing",value:function(){this._periodicPingThread&&(clearInterval(this._periodicPingThread),this._periodicPingThread=null)}},{key:"_doPing",value:function(){var e=PingHelper.GeneratePingRequest();this._mostRecentPingSent=e,this._send(e),this._mostRecentPingSentTime=Date.now()}},{key:"_handleIncomingPong",value:function(e){this._spiMessageStamp.ServerTimeDelta=e.GetServerTimeDelta(),null==this._mostRecentPongReceived&&(this.CurrentStatus!=K?(this._log.info("First pong of connection and in paired state."),this._onReadyToTransact()):this._log.info("First pong of connection but pairing process not finalised yet.")),this._mostRecentPongReceived=e,this._log.debug("PongLatency:".concat(Date.now()-this._mostRecentPingSentTime))}},{key:"_handleIncomingPing",value:function(e){var t=PongHelper.GeneratePongRessponse(e);this._send(t)}},{key:"_callGetLastTransaction",value:function(){var e=new We;this._send(e.ToMessage())}},{key:"_onSpiMessageReceived",value:function(e){var t=G.FromJson(e.Message,this._secrets);if(this._log.info("Received:"+t.DecryptedJson),Ie.IsPreauthEvent(t.EventName))this._spiPreauth._handlePreauthMessage(t);else switch(t.EventName){case a:this._handleKeyRequest(t);break;case r:this._handleKeyCheck(t);break;case u:this._handlePairResponse(t);break;case c:this._handleDropKeysAdvice(t);break;case d:this._handlePurchaseResponse(t);break;case C:this._handleRefundResponse(t);break;case v:this._handleCashoutOnlyResponse(t);break;case m:this._handleMotoPurchaseResponse(t);break;case _:this._handleSignatureRequired(t);break;case S:this._handleAuthCodeRequired(t);break;case w:this._handleGetLastTransactionResponse(t);break;case T:this.HandleSettleResponse(t);break;case P:this._handleSettlementEnquiryResponse(t);break;case l:this._handleIncomingPing(t);break;case h:this._handleIncomingPong(t);break;case R:this._handleKeyRollingRequest(t);break;case p:this._handleCancelTransactionResponse(t);break;case F:this._handleSetPosInfoResponse(t);break;case E:if(null==this._spiPat){this._send(PayAtTableConfig.FeatureDisableMessage(Z.Id("patconf")));break}this._spiPat._handleGetTableConfig(t);break;case b:this._spiPat._handleGetBillDetailsRequest(t);break;case x:this._spiPat._handleBillPaymentAdvice(t);break;case A:this._handlePrintingResponse(t);break;case M:this._handleTerminalStatusResponse(t);break;case D:this._handleBatteryLevelChanged(t);break;case I:this._handleErrorEvent(t);break;case k:this._log.info("I could not verify message from Eftpos. You might have to Un-pair Eftpos and then reconnect.");break;default:this._log.info("I don't Understand Event: ".concat(t.EventName,", ").concat(t.Data,". Perhaps I have not implemented it yet."))}}},{key:"_onWsErrorReceived",value:function(e){this._log.warn("Received WS Error: "+e.Message)}},{key:"_send",value:function(e){var t=e.ToJson(this._spiMessageStamp);return this._conn.Connected?(this._log.info("Sending: "+e.DecryptedJson),this._conn.Send(t),!0):(this._log.info("Asked to send, but not connected: "+e.DecryptedJson),!1)}},{key:"ResolveDeviceIpAddress",value:function(){var e=this;this.AutoIpResolutionEnable&&(new je).RetrieveService(this._serialNumber,this._deviceApiKey).then(function(t){t&&t.Ip&&(e.CurrentDeviceStatus=new function e(t,n){Ve(this,e),this.Ip=t,this.Last_updated=n}(t.Ip,t.Last_updated)),document.dispatchEvent(new CustomEvent("DeviceIpChanged",{detail:e.CurrentDeviceStatus}))})}}],[{key:"GetVersion",value:function(){return"2.4.5"}}]),e}();window.Spi=Ye}])});
//# sourceMappingURL=spi-client-js.js.map